<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <!--
            Copyright (c) 2013-2022 Antoine Martin <antoine@xpra.org>
            Copyright (c) 2014 Joshua Higgins <josh@kxes.net>
            Licensed under MPL 2.0
    -->

  <title>xpra websockets client</title>
  <meta charset="utf-8" />
  <meta name="description" content="xpra websockets client" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="shortcut icon" type="image/png" href="favicon.png" id="favicon" />
  <link rel="stylesheet" href="css/client.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/spinner.css" />

  <script type="text/javascript" src="js/lib/jquery.js"></script>
  <script type="text/javascript" src="js/lib/jquery-ui.js"></script>
  <script type="text/javascript" src="js/lib/jquery.ba-throttle-debounce.js"></script>
  <script type="text/javascript" src="js/lib/jquery-transform-draggable.js"></script>

  <script type="text/javascript" src="js/lib/rencode.js"></script>
  <script type="text/javascript" src="js/lib/lz4.js"></script>
  <script type="text/javascript" src="js/lib/brotli_decode.js"></script>
  <script type="text/javascript" src="js/lib/forge.js"></script>

  <script type="text/javascript" src="js/lib/jsmpeg.js"></script>
  <script type="text/javascript" src="js/lib/aurora/aurora.js"></script>
  <script type="text/javascript" src="js/lib/aurora/aurora-xpra.js"></script>

  <script type="text/javascript" src="js/lib/web-streams-ponyfill.es6.js"></script>
  <script type="text/javascript" src="js/lib/StreamSaver.js"></script>
  <script type="text/javascript" src="js/lib/FileSaver.js"></script>
  <script type="text/javascript" src="js/lib/detect-zoom.js"></script>

  <script type="text/javascript" src="js/Utilities.js"></script>
  <script type="text/javascript" src="js/Keycodes.js"></script>
  <script type="text/javascript" src="js/Protocol.js"></script>
  <script type="text/javascript" src="js/WebTransport.js"></script>
  <script type="text/javascript" src="js/Window.js"></script>
  <script type="text/javascript" src="js/Notifications.js"></script>
  <script type="text/javascript" src="js/Constants.js"></script>
  <script type="text/javascript" src="js/MediaSourceUtil.js"></script>
  <script type="text/javascript" src="js/RgbHelpers.js"></script>
  <script type="text/javascript" src="js/VideoDecoder.js"></script>
  <script type="text/javascript" src="js/OffscreenDecodeWorkerHelper.js"></script>
  <script type="text/javascript" src="js/Client.js"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
  <link rel="stylesheet" type="text/css" href="css/menu.css" />
  <script type="application/javascript" src="js/Menu.js"></script>
  <script type="application/javascript" src="js/MenuCustom.js"></script>
  <link rel="stylesheet" type="text/css" href="css/menu-skin.css" />
  <link rel="stylesheet" type="text/css" href="css/icon.css" />
  <link href="https://cdn.jsdelivr.net/npm/@flaticon/flaticon-uicons/css/all/all.css" rel="stylesheet">
  <!-- slick carousel for window preview feature -->
  <link rel="stylesheet" type="text/css" href="css/slick.css" />
  <script type="text/javascript" src="js/lib/slick.js"></script>
  <script src="js/sockjs.min.js"></script>
<script src="js/stomp.min.js"></script>
  <!-- simple-keyboard -->
  <script type="application/javascript" src="js/lib/simple-keyboard.js"></script>
  <link rel="stylesheet" href="css/simple-keyboard.css" />

</head>
<style>
  * {
    font-family: 'Arial', sans-serif;
  }

  body {
    background-image: url('./icons/bgr.png') !important;
    /* Replace with your preferred color */
    background-repeat: no-repeat;
    background-size: cover;
  }

  #start {
    height: 72%;
    transform: translateY(20%);
    margin-right: 10px;
  }

  #startmenu .-hasSubmenu ul {
    top: -3vh;
  }

  #menu_list .firstmenu a:first-child {
    display: flex;
    /* padding: 10px; */
  }

  .right_tb {
    display: flex !important;
    align-items: center;
    margin: 0px;
    list-style: none;
    position: absolute;
    right: 15px;
  }

  #float_menu {
    top: 94vh !important;
    height: 6vh !important;
  }

  .right_tb li {
    margin: 0px 10px;
  }

  .-hasSubmenu a .menu-divleft img {
    margin-right: 10px;
  }

  #startmenu .-hasSubmenu {
    margin: 5px 0px;
  }

  #menu_list li:hover {
    background-color: rgba(0, 0, 0, 0.1);
  }

  #fullscreen_button::before {
    display: none;
  }

  .new_menu {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 38vw;
    height: 40vh;
    background-color: white;
    z-index: 9998;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }
  
  .new_menu #uploadForm {
    display: flex;
    align-items: center;
    position: absolute;
    top: 16%;
    left: 50%;
  }

  .new_menu #theme {
    position: absolute;
    top: 69%;
    left: 50%;
  }

  span.left {
    position: absolute;
    top: 14%;
    font-size: 20px;
    width: 28%;
    padding: 2% 5%;
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    background-color: #ccc;
  }

  span.theme {
    position: absolute;
    top: 67%;
    font-size: 20px;
    width: 28%;
    padding: 2% 5%;
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    background-color: #ccc;
  }

  span.left:hover,
  span.theme:hover {
    background-color: #ccc;

    cursor: pointer;
  }

  .new_menu form button img {
    width: 100%;
  }

  #uploadForm button {
    padding: 10px;
    color: #fff;
    background-color: grey;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  #theme button {
    padding: 10px;
    color: #fff;
    background-color: grey;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  #uploadForm button:hover,
  #theme button:hover {
    background-color: darkgrey;
  }

  #uploadForm button img {
    width: 20px;
    height: 20px;
  }

  #fileInput {
    display: none;
  }

  #fileInputLabel {
    padding: 10px;
    color: #fff;
    background-color: #006e58;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: inline-block;
  }

  #fileInputLabel:hover {
    background-color: #90EE90;
    color: black;
  }

  #fadeBackground {
    display: none;
    z-index: 1;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .windowicon {
    display: inline-block;
    position: absolute;
    width: 1.8 vw;
    left: 1%;
    top: 0.2vh;
    overflow: hidden;
    cursor: default;
    background-color: transparent;
  }

  /* switch button */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked+.slider {
    background-color: #2196F3;
  }

  input:checked+.slider:before {
    transform: translateX(26px);
  }

  /* calendar space */
  .calendar-container {
    position: absolute;
    top: 20vh;
    display: none;
    right: 10px;
    bottom: calc(7vh);
    background: #fff;
    width: 450px;
    border-radius: 10px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
  }

  .calendar-container header {
    display: flex;
    align-items: center;
    padding: 25px 30px 10px;
    justify-content: space-between;
  }

  header .calendar-navigation {
    display: flex;
  }

  header .calendar-navigation span {
    height: 38px;
    width: 38px;
    margin: 0 1px;
    cursor: pointer;
    text-align: center;
    line-height: 38px;
    border-radius: 50%;
    user-select: none;
    color: #aeabab;
    font-size: 1.9rem;
  }

  .calendar-navigation span:last-child {
    margin-right: -10px;
  }

  header .calendar-navigation span:hover {
    background: #f2f2f2;
  }

  header .calendar-current-date {
    font-weight: 500;
    font-size: 1.45rem;
  }

  .calendar-body {
    padding: 20px;
  }

  .calendar-body ul {
    list-style: none;
    flex-wrap: wrap;
    display: flex;
    text-align: center;
  }

  .calendar-body .calendar-dates {
    margin-bottom: 20px;
  }

  .calendar-body li {
    width: calc(100% / 7);
    font-size: 1.07rem;
  }

  .calendar-body .calendar-weekdays li {
    cursor: default;
    font-weight: 500;
  }

  .calendar-body .calendar-dates li {
    margin-top: 30px;
    position: relative;
    z-index: 1;
    cursor: pointer;
  }

  .calendar-dates li.inactive {
    color: #aaa;
  }

  .calendar-dates li.active {
    color: #fff;
  }

  .calendar-dates li::before {
    position: absolute;
    content: "";
    z-index: -1;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }

  .calendar-dates li.active::before {
    background: #6332c5;
  }

  .calendar-dates li:not(.active):hover::before {
    background: #e4e1e1;
  }

  #startmenu li ul li {
    cursor: pointer;
  }
  .new_menu_1 {
    position: fixed;
    top: 19vh;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 300px;
    text-align: center; 
    z-index: 1000; 
  }


.new_menu_1 h2 {
    margin-bottom: 20px;
}

.new_menu_1 .input-group {
    margin-bottom: 15px;
    text-align: left;
}

.new_menu_1 .input-group label {
    display: block;
    margin-bottom: 5px;
}

.new_menu_1 .input-group input {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.new_menu_1 button {
    width: 100%;
    padding: 10px;
    background-color: #007bff;
    border: none;
    border-radius: 4px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
}

.new_menu_1 button:hover {
    background-color: #0056b3;
}
#notification {
  position: absolute;
  left: auto;
  right: 0;
  top: 96px;
  bottom: auto;
  width: 600px;
  height: auto;
  z-index: 10001;
  transition: height 0.5s, opacity 0.5s, top 0.5s, box-shadow 0.5s, bottom 0.5s;
  overflow: hidden;
  padding: 40px;
  display: none;
  background-color: white;
}
  /* end calendar space  */
</style>

<body>
  <div id="dpi" style="
        width: 1in;
        height: 1in;
        left: -100%;
        top: -100%;
        position: absolute;
      "></div>

  <div id="progress" class="overlay" style="display: none">
    <p id="progress-label"></p>
    <p id="progress-details"></p>
    <progress id="progress-bar" max="100" value="10"></progress>
  </div>

  <div id="login-overlay">
    <div id="login-box">
      <form id="login_form">
        <div id="login-innerbox">
          <span id="login-header"></span>
          <br />
          <input type="text" name="username" id="username" value="" autocomplete="username" style="display: none;">
          <div id="password-box">
            <input title="Password" type="password" id="password" autocomplete="current-password" placeholder="Password"
              size="16" maxlength="256" tabindex="1" required />
          </div>
          <br />
          <div id="login-buttons">
            <a class="login-button" role="button" tabindex="2" id="login_cancel" onclick="login_cancel();">Cancel</a>
            <a class="login-button" role="button" tabindex="3" id="login_connect" onclick="login_connect();">Connect</a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="screen" style="width: 100%; height: 100%">
    <div id="float_menu">
      <ul class="Menu -horizontal" style="height: 100%;">
        <li class="-hasSubmenu -noChevron" style="height: 100%;">
          <a href="#" title="Xpra" class="noDrag" style="height: 100%;">
            <img id="start" class="startLogo" src="./icons/xpra-logo.png">
          </a>
          <ul id="menu_list">
            <li class="firstmenu -hasSubmenu" style="padding: 20px 0;">
              <a class="bigmenu" href="#">
                <img id="start" src="./icons/menu-bar.png">
                Start
              </a>
              <ul id="startmenu">
              </ul>
            </li>
            <li class="firstmenu -hasSubmenu" style="padding:  22px 0;">
              <a class="bigmenu" href="#">
                <img id="start" src="./icons/server.png">
                Server</a>
              <ul style="position: relative;
                  down: -10%;
                  top: -5vh;">
                <li id="clock_menu_entry"><a href="#" data-icon="access_time" onclick="return false"
                    id="clock_menu_text"></a></li>
                <li><a href="#" data-icon="cloud_upload" onclick="upload_file(event); return false">Upload file</a></li>
                <li><a href="#" data-icon="exit_to_app" onclick="confirm_shutdown_server(event); return false">Shutdown
                    Server</a></li>
              </ul>
            </li>
            <!--
                <li class="-hasSubmenu">
                  <a href="#" data-icon="list">Features</a>
                  <ul>
                    <li><a href="#" data-icon="message">Notifications</a></li>
                  </ul>
                </li>
                -->
            <li class="firstmenu -hasSubmenu" style="padding:20px 0;">
              <a class="bigmenu" href="#">
                <img id="start" src="./icons/icon.png">
                Information</a>
              <ul style="position: relative;
                  down: -10%;
                  top: -5vh;">
                <li><a href="#" data-icon="info" onclick="show_about(event); return false">About
                    Xpra</a></li>
                <li><a href="#" data-icon="trending_up" onclick="show_sessioninfo(event); return false">Session Info</a>
                </li>
                <li><a href="#" data-icon="bug_report" onclick="show_bugreport(event); return false">Bug
                    Report</a></li>
              </ul>
            </li>
            <li style="padding: 20px 0;"><a href="#"
                onclick="client.disconnect_reason='User request'; client.close(); return false">
                <img id="start" src="./icons/disconnected.png">
                Disconnect</a></li>
          </ul>
        </li>
        <li class="-hasSubmenu -noChevron" style="height: 100%; display: none;">
          <a href="#" title="Open Windows" style="height: 100%;">
            <img id="start" src="./icons/folder-open.png">

          </a>
          <ul id="open_windows_list">
          </ul>
        </li>


      </ul>
      <ul class="right_tb" style="height: 30px;top:10%">
        <!-- <li class="-hasSubmenu -noChevron" style="height: 80%;">
            <a href="#" title="Audio">
              <img id="start" src="./icons/volume-mute.png" style="height: 2.5vh;">
            </a>
          </li> -->
        <li class="-hasSubmenu -noChevron" style="height: 80%;margin-top: 15px;">
          <!-- <a href="#" id="keyboard_button" title="clock"  >
              <img id="start" src="./icons/clock.png">
            </a> -->
          <div id="clock" style="font-size: 24px;"></div>
        </li>
        <li class="-hasSubmenu -noChevron" style="height: 100%;margin-top: 10px;">
          <a href="#" id="calendar_button" title="Calendar">
            <img id="start" src="./icons/calendar-day.png">
          </a>
        </li>
        <li class="-hasSubmenu -noChevron" style="height: 100%;margin-top: 10px ;">
          <a href="#" id="fullscreen_button" title="Fullscreen" style="height: 100%;">
            <img id="start" src="./icons/expand.png">
          </a>
        </li>
        <li class="-hasSubmenu -noChevron" style="height: 100%;margin-top: 10px;">
          <a href="#" id="keyboard_button" title="Keyboard" style="height: 100%;">
            <img id="start" src="./icons/keyboard.png">
          </a>
        </li>
        <li class="-hasSubmenu -noChevron" style="height: 100%;margin-top: 10px;">
          <a href="#" id="setting" title="setting" style="height: 100%;">
            <img id="start" src="./icons/settings.png">
          </a>
        </li>
      </ul>
      <div id="float_tray" class="menu-divright"></div>
    </div>
    <img id="shadow_pointer" alt="shadow pointer" />
  </div>

  <div id="window_preview"></div>


  <form id="upload_form">
    <input type="file" id="upload" style="display: none" />
  </form>
  <div class="new_menu">
    <span id="exitmenu" style="position: absolute; top: 2% ; right: 2%; cursor: pointer;"><img style="width: 30px;"
        src="./icons/logout.png" alt=""></span>
    <span class="left">Change Background</span>
    <form id="uploadForm">
      <input type="file" id="fileInput">
      <label for="fileInput" id="fileInputLabel">Choose File
      </label>
      <button type="submit" style="margin-left:10px ;"><img src="./icons/upload.png" alt=""></button>
    </form>
    <span class="theme">Dark Mode</span>
    <form id="theme">
      <label class="switch">
        <input type="checkbox">
        <span class="slider"></span>
      </label>
    </form>
  </div>
</div>

  <div id="about">
    <h2>Xpra HTML5 Client</h2>
    <h3>Version 15 beta</h3>
    <span>
      Copyright (c) 2013-2024 Antoine Martin &lt;antoine@xpra.org&gt;
      <br />
      Copyright (c) 2014 Joshua Higgins &lt;josh@kxes.net&gt;
    </span>
    <br />
    <br />
    <span class="info">
      This code is available under the
      <a href="./LICENSE">Mozilla Public License Version 2.0</a>
      <br />
      For more information, see
      <a rel="noopener" href="https://github.com/Xpra-org/xpra-html5">xpra HTML5 project</a>.
    </span>
  </div>

  <div id="sessioninfo">
    <h2>Session Information</h2>
    <h3>Connection Data</h3>
    <table id="sessiondata">
      <caption>
        Session Connection Data Information
      </caption>
      <tr>
        <th scope="row">Server Endpoint</th>
        <td id="endpoint"></td>
      </tr>
      <tr>
        <th scope="row">Server Display</th>
        <td id="server_display"></td>
      </tr>
      <tr>
        <th scope="row">Server Platform</th>
        <td id="server_platform"></td>
      </tr>
      <tr>
        <th scope="row">Server Load</th>
        <td id="server_load"></td>
      </tr>
      <tr>
        <th scope="row">Session Connected</th>
        <td id="session_connected"></td>
      </tr>
      <tr>
        <th scope="row">Server Latency</th>
        <td id="server_latency"></td>
      </tr>
      <tr>
        <th scope="row">Client Latency</th>
        <td id="client_latency"></td>
      </tr>
    </table>
  </div>

  <div id="bugreport">
    <h2>Xpra Bug Report</h2>
    <br />
    <form>
      Summary:
      <input id="bugreport_summary" type="text" size="48" maxlength="128" value="" />
      <br />
      Description:
      <br />
      <textarea id="bugreport_description" cols="60" rows="6"></textarea>
      <br />
      <button id="bugreport_cancel" type="button" onclick="hide_bugreport()">
        Cancel
      </button>
      <button id="bugreport_submit" type="button" onclick="generate_bugreport()" disabled>
        Generate Report
      </button>
    </form>
  </div>

  <div>
    <textarea id="pasteboard" readonly style="display: block; position: absolute; left: -99em"></textarea>
  </div>

  <div class="simple-keyboard" style="display: block; position: fixed; bottom: 6vh; width: 100%"></div>
  <!-- calendar space -->
  <div class="calendar-container">
    <header class="calendar-header">
      <p class="calendar-current-date"></p>
      <div class="calendar-navigation">
        <span id="calendar-prev" class="material-symbols-rounded">
          <img src="./icons/angle-left.png" alt="" style="width: 70%;">
        </span>
        <span id="calendar-next" class="material-symbols-rounded">
          <img src="./icons/angle-right.png" alt="" style="width: 70%;">
        </span>
      </div>
    </header>

    <div class="calendar-body">
      <ul class="calendar-weekdays" style="padding: 0">
        <li>Sun</li>
        <li>Mon</li>
        <li>Tue</li>
        <li>Wed</li>
        <li>Thu</li>
        <li>Fri</li>
        <li>Sat</li>
      </ul>
      <ul class="calendar-dates" style="padding:0"></ul>
    </div>
  </div>
  <div id="notification"></div>

  <!-- "<div id="spinner18" class="spinneroverlay" style="display: none;">
		<div class="spinnermiddle">
			<div class="spinner"></div>
		</div>
	</div>
	<div id="head18" class="windowhead" style="display: none;"> <span class="windowicon"></span> <span
			class="windowtitle" id="title18" style="left: 32px;">Home</span> <span class="windowbuttons"> <span
				id="minimize18"><img src="icons/minimize.png"></span> <span id="maximize18"><img
					src="icons/maximize.png"></span> <span id="close18"><img src="icons/close.png"></span> </span></div>
	<canvas width="894" height="585"></canvas>
	<div class="ui-resizable-handle ui-resizable-n" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-e" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-s" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-w" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-ne" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-sw" style="z-index: 90;"></div>
	<div class="ui-resizable-handle ui-resizable-nw" style="z-index: 90;"></div>" -->


  <!-- end space -->
  <script>
function testDocker() {
  const port = window.location.port;
    fetch('http://localhost:8082/test-docker/'+ port, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data);
        // Xử lý dữ liệu nhận được ở đây
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
function parseString(s) {
    return s.slice(1, -1).split(", ").reduce((obj, pair) => {
        const [key, value] = pair.split("=");
        obj[key] = value.replace("%", "");
        return obj;
    }, {});
}
// Gọi hàm
testDocker();
    if(localStorage.getItem('user_authen') == null){
        window.location.href = '/connect.html'; // Redirect to login page
    }
       setTimeout(() => {
          localStorage.removeItem('user_authen');
          window.location.href = '/connect.html'; // Redirect to login page
      }, 72000000); // 5s
    const socket = new SockJS('http://localhost:8082/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
    console.log('Connected: ' + frame);
    stompClient.subscribe('/topic/docker-stats', function(message) {
      console.log("body la"+ message.body);
      const data = parseString(message.body);
      console.log('Memory Usage: ' + data.memoryUsage);
      console.log('CPU Usage: ' + data.cpuUsage);
        // Ở đây bạn có thể cập nhật UI với dữ liệu nhận được
        if(parseFloat(data.cpuUsage) > 10){
          alert("CPU Usage is over 50%");
        }
        if(parseFloat(data.memoryUsage) > 1){
          alert("Memory Usage is over 50%");
        }
    });
});

     const liElement = document.querySelector('#startmenu .-hasSubmenu');
        
        
        // Set the src attribute of the <img> tag
          console.log(liElement);
        // start self changing
    let count = 0;
    document.querySelector('span.slider').addEventListener('click', function (event) {
      // day la doan xu ly theme
      count++;
      if (count % 2 == 0) {
        //theme light
        document.getElementById('float_menu').style.backgroundColor = 'rgba(139, 211, 230, 1)';
        document.querySelector('.new_menu').style.backgroundColor = 'white';
        document.querySelector('li #calendar_button img').src = './icons/calendar-day.png';
        document.getElementById('clock').style.color = 'black';
        document.querySelector('.startLogo').src = './icons/xpra-logo.png';
        document.querySelector('li #fullscreen_button img').src = './icons/expand.png';
        document.querySelector('li #keyboard_button img').src = './icons/keyboard.png';
        document.querySelector('li #setting img').src = './icons/settings.png';
        document.querySelector('.new_menu #exitmenu img').src = './icons/logout.png';
        document.querySelector('.calendar-container').style.backgroundColor = 'white';
        document.querySelector('.calendar-container').style.color = 'black';
        document.getElementById('menu_list').style.backgroundColor = 'white';
        document.getElementById('menu_list').style.color = 'black';
        var elements = document.querySelectorAll('#menu_list li ul');
        elements.forEach(function (element) {
          element.style.backgroundColor = 'white';
        });
        var elements = document.querySelectorAll('#startmenu li ul');
        elements.forEach(function (element) {
          element.style.backgroundColor = 'white';
        });
      }
      else {
        //theme dark
        document.getElementById('float_menu').style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        document.querySelector('.new_menu').style.backgroundColor = '#2f2f2f';
        document.querySelector('li #calendar_button img').src = 'https://res.cloudinary.com/dlggnttqv/image/upload/v1721706117/calendar_light_pbb32x.png';
        document.getElementById('clock').style.color = 'white';
        document.querySelector('.startLogo').src = 'https://res.cloudinary.com/dlggnttqv/image/upload/v1721705704/xpra-logo_light_e3ngxb.png';
        document.querySelector('li #fullscreen_button img').src = 'https://res.cloudinary.com/dlggnttqv/image/upload/v1721705944/expand_light_wdn9nw.png';
        document.querySelector('li #keyboard_button img').src = './icons/keyboard_light.png';
        document.querySelector('li #setting img').src = './icons/setting_light.png';
        document.querySelector('.new_menu #exitmenu img').src = './icons/logout_light.png';
        document.querySelector('.calendar-container').style.backgroundColor = 'black';
        document.querySelector('.calendar-container').style.color = 'white';
        document.getElementById('menu_list').style.backgroundColor = '#003049';
        document.getElementById('menu_list').style.color = 'white';
        var elements = document.querySelectorAll('#menu_list li ul');
        elements.forEach(function (element) {
          element.style.backgroundColor = '#003049';
        });
        var elements = document.querySelectorAll('#menu_list li ul');
        elements.forEach(function (element) {
          element.style.backgroundColor = '#003049';
        });
        var elements = document.querySelectorAll('#startmenu li ul');
        elements.forEach(function (element) {
          element.style.backgroundColor = '#003049';
        });
      }
    });
    // xu ly phan icon duoi taskbar

    // document.querySelector('img#start').addEventListener('click', function (event) {
    // 	var elements = document.querySelectorAll('#startmenu li ul li');
    // 	elements.forEach(function (element) {
    // 		element.addEventListener('click', function (event) {
    // 			var image = document.createElement('img');
    // 			var newListItem = document.createElement('li');
    // 			var icon = element.querySelector('div img');
    // 			var iconCopy = icon.cloneNode(true);
    // 			newListItem.appendChild(iconCopy);

    // 			var menu = document.querySelector('.Menu.-horizontal');
    // 			var children = Array.from(menu.children);
    // 			var doesExist = children.some(function (child) {
    // 				return child.innerHTML === newListItem.innerHTML;
    // 			});

    // 			if (!doesExist) {
    // 				menu.appendChild(newListItem);
    // 			}

    // 		})
    // 	});
    // });


    // calendar space
    let date = new Date();
    let year = date.getFullYear();
    let month = date.getMonth();

    const day = document.querySelector(".calendar-dates");

    const currdate = document
      .querySelector(".calendar-current-date");

    const prenexIcons = document
      .querySelectorAll(".calendar-navigation span");

    // Array of month names
    const months = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December"
    ];

    // Function to generate the calendar
    const manipulate = () => {

      // Get the first day of the month
      let dayone = new Date(year, month, 1).getDay();

      // Get the last date of the month
      let lastdate = new Date(year, month + 1, 0).getDate();

      // Get the day of the last date of the month
      let dayend = new Date(year, month, lastdate).getDay();

      // Get the last date of the previous month
      let monthlastdate = new Date(year, month, 0).getDate();

      // Variable to store the generated calendar HTML
      let lit = "";

      // Loop to add the last dates of the previous month
      for (let i = dayone; i > 0; i--) {
        lit +=
          `<li class="inactive">${monthlastdate - i + 1}</li>`;
      }

      // Loop to add the dates of the current month
      for (let i = 1; i <= lastdate; i++) {

        // Check if the current date is today
        let isToday = i === date.getDate()
          && month === new Date().getMonth()
          && year === new Date().getFullYear()
          ? "active"
          : "";
        lit += `<li class="${isToday}">${i}</li>`;
      }

      // Loop to add the first dates of the next month
      for (let i = dayend; i < 6; i++) {
        lit += `<li class="inactive">${i - dayend + 1}</li>`
      }

      // Update the text of the current date element 
      // with the formatted current month and year
      currdate.innerText = `${months[month]} ${year}`;

      // update the HTML of the dates element 
      // with the generated calendar
      day.innerHTML = lit;
    }

    manipulate();

    // Attach a click event listener to each icon
    prenexIcons.forEach(icon => {

      // When an icon is clicked
      icon.addEventListener("click", () => {

        // Check if the icon is "calendar-prev"
        // or "calendar-next"
        month = icon.id === "calendar-prev" ? month - 1 : month + 1;

        // Check if the month is out of range
        if (month < 0 || month > 11) {

          // Set the date to the first day of the 
          // month with the new year
          date = new Date(year, month, new Date().getDate());

          // Set the year to the new year
          year = date.getFullYear();

          // Set the month to the new month
          month = date.getMonth();
        }

        else {

          // Set the date to the current date
          date = new Date();
        }

        // Call the manipulate function to 
        // update the calendar display
        manipulate();
      });
    });
    document.getElementById('calendar_button').addEventListener('click', function (event) {
      event.preventDefault();
      var calendar = document.querySelector('.calendar-container');
      if (calendar.style.display === 'block') {
        calendar.style.display = 'none';
      }
      else {
        calendar.style.display = 'block';
      }
    });

    // end calendar space
    document.getElementById('exitmenu').addEventListener('click', function (event) {
      event.preventDefault();
      var newMenu = document.querySelector('.new_menu');
      newMenu.style.display = 'none';
      document.getElementById('fadeBackground').style.display = 'none';
    });
    // click button setting
    document.getElementById('setting').addEventListener('click', function (event) {
      event.preventDefault();
      var newMenu = document.querySelector('.new_menu');
      if (newMenu.style.display === 'flex') {
        newMenu.style.display = 'none';
        document.getElementById('fadeBackground').style.display = 'none';
      }
      else {
        newMenu.style.display = 'flex';
        document.getElementById('fadeBackground').style.display = 'block';
      }
    });
    // document.querySelector("span.left").addEventListener('click', function (event) {
    // 	var formFile = document.querySelector(".new_menu form");
    // 	var button = document.querySelector("span.left");
    // 	var style = window.getComputedStyle(formFile);

    // 	if (style.display === 'block') {
    // 		formFile.style.display = 'none';
    // 		button.style.background = "white";
    // 		document.getElementById('fadeBackground').style.display = 'none';
    // 	}
    // 	else {
    // 		formFile.style.display = 'block';
    // 		button.style.background = "#ccc";
    // 		document.getElementById('fadeBackground').style.display = 'block';
    // 	}
    // });
    var clockElement = document.getElementById('clock');

    function updateClock(clock) {
      var date = new Date();
      var hours = date.getHours().toString().padStart(2, '0');
      var minutes = date.getMinutes().toString().padStart(2, '0');
      clock.textContent = hours + ":" + minutes;
    }

    setInterval(function () {
      updateClock(clockElement);
    }, 1000);

    // document.getElementById('start').addEventListener('click', function() {

    // 	var displayStyle = clockElement.style.display;
    // 	if (displayStyle === 'none') {
    // 		clockElement.style.display = 'block';
    // 	} else {
    // 		clockElement.style.display = 'none';
    // 	}
    // });
    document.getElementById('fileInput').addEventListener('change', function () {
      var fileInputLabel = document.getElementById('fileInputLabel');
      var file = this.files[0];
      if (file) {
        fileInputLabel.textContent = file.name;
      } else {
        fileInputLabel.textContent = 'Choose File';
      }
    });


    document.getElementById('uploadForm').addEventListener('submit', function (event) {
      event.preventDefault();

      var fileInput = document.getElementById('fileInput');
      var file = fileInput.files[0];
      var formData = new FormData();
      formData.append('file', file);

      fetch('http://localhost:5210/render-image', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          console.log(data);
          location.reload();
        }
        )
        .catch(error => console.error('Error:', error));
    });
    // end self chaging
    var default_settings = {};
    var getparam = function (prop) {
      var v = Utilities.getparam(prop);
      if (v == undefined && prop in default_settings) {
        v = default_settings[prop];
        clog("using", prop, "=", v, " from default settings");
      } else if (v != null && v != "") {
        clog("using", prop, "=", v, " from parameters");
      }
      return v;
    };

    var getboolparam = function (prop, default_value) {
      var v = getparam(prop);
      return Utilities.stristrue(v, default_value);
    };
    var getboolautoparam = function (prop, default_value) {
      var v = getparam(prop);
      if (v == "auto") {
        return "auto";
      }
      return Utilities.stristrue(v, default_value);
    };
    var getintparam = function (prop, default_value) {
      var v = getparam(prop);
      try {
        v = parseInt(v);
      } catch (e) {
        return default_value;
      }
      if (v === null || isNaN(v)) {
        return default_value;
      }
      return v;
    };
    var getfloatparam = function (prop, default_value) {
      var v = getparam(prop);
      try {
        v = parseFloat(v);
      } catch (e) {
        return default_value;
      }
      if (v === null || isNaN(v)) {
        return default_value;
      }
      return v;
    };

    var float_menu_item_count = 6;
    var float_menu_item_size = 30;
    var float_menu_padding = 20;
    var float_menu_width = float_menu_item_size * float_menu_item_count + float_menu_padding;

    var cdebug = function () {
      Utilities.clog.apply(Utilities, arguments);
    };
    var clog = function () {
      Utilities.clog.apply(Utilities, arguments);
    };

    //start calculating the fps asap:
    var animation_times = [];
    var fps = -1;
    var vrefresh = -1;
    function animation_cb(now) {
      var l = animation_times.push(now);
      if (l > 100) {
        animation_times.shift();
      }
      var t0 = animation_times[0];
      if (now > t0) {
        fps = Math.floor((1000 * (l - 1)) / (now - t0));
      }
      cdebug("draw", "animation_cb", now, "fps", fps, "vrefresh", vrefresh);
      if (vrefresh < 0) {
        window.requestAnimationFrame(animation_cb);
      }
    }
    window.requestAnimationFrame(animation_cb);

    function confirm_shutdown_server() {
      if (confirm("Shutdown this server?")) {
        client.reconnect = false;
        client.send(["shutdown-server"]);
      }
    }

    function upload_file(event) {
      $(".menu-content").slideUp();
      $("#upload").click();
    }

    function download_file(event) {
      $(".menu-content").slideUp();
      var command = ["xpra", "send-file"]
      client.send(["start-command", "Client-Download-File", command, true, true]);
    }

    function cleanup_dialogs() {
      $(".menu-content").slideUp();
      $("#about").hide();
      hide_sessioninfo();
      hide_bugreport();
    }
    function connection_established() {
      //this may be a re-connection,
      //so make sure we cleanup any left-overs
      clog("connection-established");
      cleanup_dialogs();
      $("button.menu-button").prop("disabled", false);
    }
    function connection_lost() {
      clog("connection-lost");
      cleanup_dialogs();
      $("button.menu-button").prop("disabled", true);
    }
    document.addEventListener("connection-established", connection_established);
    document.addEventListener("connection-lost", connection_lost);

    $("body").click(function () {
      $(".menu-content").slideUp();
      $("#about").hide();
      hide_sessioninfo();
    });

    function enable_clipboard_autofocus() {
      $("#pasteboard").blur(function () {
        //force focus back to our capture widget:
        if (client.capture_keyboard) {
          $("#pasteboard").focus();
        }
      });
      var pasteboard_element = $("#pasteboard");
      pasteboard_element.prop("autofocus");
      pasteboard_element.focus();
    }
    function cancel_clipboard_autofocus() {
      $("#pasteboard").removeAttr("autofocus");
    }

    function show_about(event) {
      $(".menu-content").slideUp();
      $("#about").show();
      hide_sessioninfo();
      event.stopPropagation();
    }

    //session-info handling:
    function show_sessioninfo(event) {
      $(".menu-content").slideUp();
      $("#about").hide();
      $("#sessiondata td").html("");
      $("#sessioninfo").show();
      client.start_info_timer();
      event.stopPropagation();
    }
    function hide_sessioninfo() {
      $("#sessioninfo").hide();
      client.stop_info_timer();
    }
    document.addEventListener(
      "info-response",
      function (e) {
        var info = e.data;
        $("#endpoint").html(client.uri);
        $("#server_display").html(client.server_display);
        $("#server_platform").html(client.server_platform);
        if (client.server_load == null) {
          $("#server_load").html("n/a");
        } else {
          $("#server_load").html("" + client.server_load);
        }
        function toHHMMSS(t) {
          var s = "";
          var hh = Math.floor(t / 1000 / 60 / 60);
          if (hh > 0) s += "" + hh + ":";
          var mm = Math.floor(t / 1000 / 60) % 60;
          s += ("0" + mm).slice(-2); //left pad with "0"
          var ss = Math.floor(t / 1000) % 60;
          s += ":" + ("0" + ss).slice(-2); //left pad with "0"
          return s;
        }
        var elapsed = new Date().getTime() - client.client_start_time;
        $("#session_connected").html(toHHMMSS(elapsed));
        if (client.server_ping_latency >= 0)
          $("#server_latency").html(client.server_ping_latency);
        if (client.client_ping_latency >= 0)
          $("#client_latency").html(client.client_ping_latency);
        //TODO:
        // * add packet counter to Protocol.js
        //"Packets Received"
        //"Encoding + Compression"
      },
      false
    );

    function enable_bugreport_submit() {
      $("#bugreport_submit").prop("disabled", false);
      document.removeEventListener("info-response", enable_bugreport_submit);
    }
    function hide_bugreport() {
      $("#bugreport").hide();
      if (client.clipboard_enabled) {
        enable_clipboard_autofocus();
      }
    }
    function show_bugreport(event) {
      //stop capturing input, so we can interact with the bugreport form:
      client.capture_keyboard = false;
      cancel_clipboard_autofocus();
      //hide menu:
      $(".menu-content").slideUp();
      $("#bugreport").show();
      event.stopPropagation();
      //disable submit until we get an info-response:
      $("#bugreport_submit").prop("disabled", true);
      document.addEventListener("info-response", enable_bugreport_submit);
      client.send_info_request();
    }
    function generate_bugreport() {
      client.capture_keyboard = true;
      var zip = new JSZip();
      zip.file(
        "Summary.txt",
        "" +
        $("#bugreport_summary").val() +
        "\n\n" +
        $("#bugreport_description").val()
      );
      zip.file(
        "Server-Info.txt",
        "" + JSON.stringify(client.server_last_info)
      );
      //screenshot:
      if (!client.offscreen_api) {
        var canvas = document.createElement("canvas");
        canvas.width = client.desktop_width;
        canvas.height = client.desktop_height;
        var ctx = canvas.getContext("2d");
        for (var i in client.id_to_window) {
          var iwin = client.id_to_window[i];
          ctx.drawImage(iwin.draw_canvas, iwin.x, iwin.y);
        }
        var png_base64 = canvas.toDataURL("image/png");
        zip.file(
          "screenshot.png",
          Utilities.convertDataURIToBinary(png_base64)
        );
      }
      zip.generateAsync({ type: "blob" }).then(function (content) {
        saveAs(content, "bugreport.zip");
      });
      hide_bugreport();
    }
    var password_input = document.getElementById("password");
    var login_callback = null;
    function login_cancel() {
      $("#login-overlay").fadeOut();
      password_input.removeEventListener("keydown", password_special_keys);
      password_input.value = "";
      login_callback(null);
    }
    function login_connect() {
      $("#login-overlay").fadeOut();
      var password = password_input.value;
      password_input.removeEventListener("keydown", password_special_keys);
      password_input.value = "";
      login_callback(password);
    }
    function password_special_keys(e) {
      if (e.keyCode == 13) {
        e.preventDefault();
        login_connect();
      }
      if (e.keyCode == 27) {
        e.preventDefault();
        login_cancel();
      }
    }
    function password_prompt_fn(heading, callback) {
      login_callback = callback;
      $("#login-overlay").fadeIn();
      $("#login-header").text(heading);
      password_input.focus();
      password_input.addEventListener("keydown", password_special_keys);
    }

    function keycloak_prompt_fn(url, callback) {
      var params = new URLSearchParams(window.location.search);
      var code = params.get("code");
      var error = params.get("error");
      if (error) {
        var error_description = params.get("error_description");
        callback(JSON.stringify({ error, error_description }));
      } else if (!code) {
        window.location.href = url;
      } else {
        history.replaceState({}, "", window.location.pathname);
        callback(JSON.stringify({ code }));
      }
    }

    var touchaction_scroll = true;
    function toggle_touchaction() {
      touchaction_scroll = !touchaction_scroll;
      set_touchaction();
    }
    function set_touchaction() {
      var touchaction, label;
      if (touchaction_scroll) {
        touchaction = "none";
        label = "zoom";
      } else {
        touchaction = "auto";
        label = "scroll";
      }
      cdebug("mouse", "set_touchaction() touchaction=", touchaction, "label=", label);
      $("div.window canvas").css("touch-action", touchaction);
      $("#touchaction_link").html("Set Touch Action: " + label);
      if (!Utilities.isEdge()) {
        $("#touchaction_link").hide();
      }
    }

    function init_client() {
      if (typeof jQuery == "undefined") {
        window.alert("Incomplete Xpra HTML5 client installation: jQuery is missing, cannot continue.");
        return;
      }
      var https = document.location.protocol == "https:";

      // look at url parameters
      var username = getparam("username") || getparam("handle") || null;
      var passwords = [];
      for (var i = 0; i < 10; i++) {
        var password = getparam("password" + i) || getparam("token" + i) || null;
        if (!password && i == 0) {
          //try with no suffix:
          password = getparam("password") || getparam("token") || null;
        }
        if (password) {
          passwords.push(password);
        } else {
          break;
        }
      }
      var sound = getboolparam("sound", true) || null;
      var audio_codec = getparam("audio_codec") || null;
      var offscreen = getboolparam("offscreen", true);
      var encoding = getparam("encoding") || null;
      var bandwidth_limit = getintparam("bandwidth_limit", 0) || 0;
      var action = getparam("action") || "connect";
      var display = getparam("display") || "";
      var shadow_display = getparam("shadow_display") || "";
      var submit = getboolparam("submit", true);
      var server = getparam("server") || window.location.hostname;
      var port = getparam("port") || window.location.port;
      var ssl = getboolparam("ssl", https);
      var webtransport = getboolparam("webtransport", false);
      var path = getparam("path") || window.location.pathname;
      var encryption = getparam("encryption") || null;
      var key = getparam("key") || null;
      var keyboard_layout = getparam("keyboard_layout") || null;
      var start = getparam("start");
      var exit_with_children = getboolparam("exit_with_children", false);
      var exit_with_client = getboolparam("exit_with_client", false);
      var sharing = getboolparam("sharing", false);
      var video = getboolparam("video", Utilities.is_64bit());
      var mediasource_video = getboolparam("mediasource_video", false);
      var remote_logging = getboolparam("remote_logging", true);
      var insecure = getboolparam("insecure", false);
      var ignore_audio_blacklist = getboolparam("ignore_audio_blacklist", false);
      var keyboard = getboolparam("keyboard", Utilities.isMobile());
      // Some browsers trigger ugly popups if we try to read the clipboard
      // Safari: https://github.com/Xpra-org/xpra-html5/issues/226
      // Firefox: https://github.com/Xpra-org/xpra-html5/issues/301
      var clipboard = getboolparam("clipboard", true);
      var cpoll = !Utilities.isFirefox();
      if (Utilities.isSafari()) {
        cpoll = !ssl;
      }
      var clipboard_poll = getboolparam("clipboard_poll", cpoll);
      var clipboard_preferred_format = getparam("clipboard_preferred_format") || "text/plain";
      var printing = getboolparam("printing", true);
      var file_transfer = getboolparam("file_transfer", true);
      var steal = getboolparam("steal", true);
      var reconnect = getboolparam("reconnect", true);
      var swap_keys = getboolparam("swap_keys", Utilities.isMacOS());
      var scroll_reverse_x = getboolparam("scroll_reverse_x", false);
      var scroll_reverse_y = getboolautoparam("scroll_reverse_y", null);
      var floating_menu = getboolparam("floating_menu", true);
      var toolbar_position = getparam("toolbar_position");
      var autohide = getboolparam("autohide", false);
      var override_width = getfloatparam("override_width", window.innerWidth);
      vrefresh = getintparam("vrefresh", -1);
      if (vrefresh < 0 && fps >= 30) {
        vrefresh = fps;
      }

      try {
        Utilities.setSessionStorageValue("password", null);
      } catch (e) {
        //ignore
      }
      try {
        Utilities.setSessionStorageValue("token", null);
      } catch (e) {
        //ignore
      }

      var username_input = document.getElementById("username");
      username_input.value = username || "none";

      var scale = 1;
      if (window.innerWidth !== override_width) {
        scale = override_width / window.innerWidth;
      }

      var progress_timer;
      var progress_value = 0;
      var progress_offset = 0;
      // show connection progress:
      function connection_progress(state, details, progress) {
        clog(
          "connection_progress(",
          state,
          ", ",
          details,
          ", ",
          progress,
          ")"
        );
        if (progress >= 100) {
          $("#progress").hide();
        } else {
          $("#progress").show();
        }
        $("#progress-label").text(state || " ");
        $("#progress-details").text(details || " ");
        $("#progress-bar").val(progress);
        var progress_value = progress;
        if (progress_timer) {
          window.clearTimeout(progress_timer);
          progress_timer = null;
        }
        if (progress < 100) {
          progress_move_offset();
        }
      }
      // the offset is just to make the user feel better
      // nothing changes, but we just show a slow progress
      function progress_move_offset() {
        progress_timer = null;
        progress_offset++;
        $("#progress-bar").val(progress_value + progress_offset);
        if (progress_offset < 9) {
          progress_timer = window.setTimeout(
            progress_move_offset,
            (5 + progress_offset) * progress_offset
          );
        }
      }

      var debug;
      var debug_categories = [];
      var categories = [
        "main",
        "keyboard",
        "geometry",
        "mouse",
        "clipboard",
        "draw",
        "audio",
        "network",
        "file",
      ];

      for (var i = 0; i < categories.length; i++) {
        var category = categories[i];
        debug = getboolparam("debug_" + category, false);
        if (debug) {
          debug_categories.push(category);
        }
      }
      clog("debug enabled for:", debug_categories);

      // create the client
      var client = new XpraClient("screen");
      client.debug_categories = debug_categories;
      client.remote_logging = remote_logging;
      client.sharing = sharing;
      client.insecure = insecure;
      client.clipboard_enabled = clipboard;
      client.clipboard_poll = clipboard_poll;
      client.clipboard_preferred_format = clipboard_preferred_format;
      client.printing = printing;
      client.file_transfer = file_transfer;
      client.bandwidth_limit = bandwidth_limit;
      client.steal = steal;
      client.reconnect = reconnect;
      client.swap_keys = swap_keys;
      client.on_connection_progress = connection_progress;
      client.scroll_reverse_x = scroll_reverse_x;
      client.scroll_reverse_y = scroll_reverse_y;
      client.vrefresh = vrefresh;
      client.scale = scale;
      // example overrides:
      //   `client.HELLO_TIMEOUT = 3600000;`
      //   `client.PING_TIMEOUT = 60000;`
      //   `client.PING_GRACE = 30000;`
      //   `client.PING_FREQUENCY = 15000;`

      if (debug) {
        //example of client event hooks:
        client.on_open = function () {
          cdebug("network", "connection open");
        };
        client.on_connect = function () {
          cdebug("network", "connection established");
        };
        client.on_first_ui_event = function () {
          cdebug("network", "first ui event");
        };
        client.on_last_window = function () {
          cdebug("network", "last window disappeared");
        };
      }

      if (video) {
        // VPX checks. Will only succeed if we can use VideoDecoder.js
        client.check_encodings.push("h264");
        client.check_encodings.push("vp8");
        client.check_encodings.push("vp9");

        if (JSMpeg && JSMpeg.Renderer && JSMpeg.Decoder) {
          //TODO: should be moved to 'check_encodings'
          //and added to the decode worker:
          client.supported_encodings.push("mpeg1");
        }
        if (mediasource_video) {
          client.supported_encodings.push(
            "vp8+webm",
            "h264+mp4",
            "mpeg4+mp4"
          );
        }
      }
      if (encoding) {
        // the primary encoding
        client.set_encoding(encoding);
      }
      for (var key of [
        "scaling.control",
        "initial_quality",
        "initial_speed",
        "auto_refresh_delay",
        "speed",
        "min-speed",
        "quality",
        "min-quality",
      ]) {
        var v = getintparam(key, -1);
        if (v >= 0) {
          client.set_encoding_option(key, v);
        }
      }
      client.offscreen_api = offscreen && client.offscreen_api;

      if (action && action != "connect") {
        var sns = {
          mode: action,
        };
        if (exit_with_children) {
          sns["exit-with-children"] = true;
          if (start) {
            sns["start-child"] = [start];
          }
        } else {
          if (start) {
            sns["start"] = [start];
          }
        }
        if (exit_with_client) {
          sns["exit-with-client"] = true;
        }
        client.start_new_session = sns;
      }

      // sound support
      if (sound) {
        client.audio_enabled = true;
        clog("sound enabled, audio codec string: " + audio_codec);
        if (audio_codec && audio_codec.includes(":")) {
          var acparts = audio_codec.split(":");
          client.audio_framework = acparts[0];
          client.audio_codec = acparts[1];
        }
        client.audio_mediasource_enabled = getboolparam("mediasource", true);
        client.audio_aurora_enabled = getboolparam("aurora", true);
        client.audio_httpstream_enabled = getboolparam("http-stream", true);
      }

      if (keyboard_layout) {
        client.keyboard_layout = keyboard_layout;
      }

      // check for username and password
      if (username) {
        client.username = username;
      }
      if (passwords) {
        client.passwords = passwords;
      }
      if (action == "connect") {
        client.server_display = display;
      } else if (action == "shadow") {
        client.server_display = shadow_display;
      }

      // check for encryption parameters
      if (encryption && ["0", "false", "no", "disabled"].indexOf(encryption.toLowerCase()) < 0) {
        client.encryption = encryption.toUpperCase();
        if (key) {
          client.encryption_key = key;
        }
        console.log("encryption:", client.encryption);
      }

      // attach a callback for when client closes
      var debug_main = getboolparam("debug_main", false);
      if (!debug_main) {
        client.callback_close = function (reason) {
          clog("closing: ", reason);
          if (!submit) {
            // if we didn't submit through the form, silently redirect to the connect gui
            window.location = "connect.html";
            return;
          }
          var message = "Connection closed (socket closed)";
          if (reason) {
            message = reason;
          }
          var url = "./connect.html";
          var has_session_storage = Utilities.hasSessionStorage();
          function add_prop(prop, value) {
            if (has_session_storage) {
              Utilities.setSessionStorageValue(prop, value);
            } else {
              if (value === null || value === "undefined") {
                value = "";
              }
              url = url + "&" + prop + "=" + encodeURIComponent("" + value);
            }
          }
          add_prop("disconnect", message);
          var props = {
            username: username,
            insecure: insecure,
            server: server,
            port: port,
            ssl: ssl,
            webtransport: webtransport,
            path: path,
            encryption: encryption,
            encoding: encoding,
            bandwidth_limit: bandwidth_limit,
            keyboard_layout: keyboard_layout,
            swap_keys: swap_keys,
            scroll_reverse_x: scroll_reverse_x,
            scroll_reverse_y: scroll_reverse_y,
            reconnect: reconnect,
            action: action,
            display: display,
            shadow_display: shadow_display,
            start: start,
            sound: sound,
            audio_codec: audio_codec,
            keyboard: keyboard,
            clipboard: clipboard,
            clipboard_poll: clipboard_poll,
            clipboard_preferred_format: clipboard_preferred_format,
            printing: printing,
            file_transfer: file_transfer,
            exit_with_children: exit_with_children,
            exit_with_client: exit_with_client,
            sharing: sharing,
            steal: steal,
            video: video,
            mediasource_video: mediasource_video,
            remote_logging: remote_logging,
            ignore_audio_blacklist: ignore_audio_blacklist,
            floating_menu: floating_menu,
            toolbar_position: toolbar_position,
            autohide: autohide,
          };
          for (var i = 0; i < client.debug_categories.length; i++) {
            var category = client.debug_categories[i];
            props["debug_" + category] = true;
          }
          if (insecure || Utilities.hasSessionStorage()) {
            for (var i = 0; i < passwords.length; i++) {
              add_prop("password" + i, passwords[i]);
            }
          } else {
            props["password"] = "";
          }
          for (var name in props) {
            var value = props[name];
            add_prop(name, value);
          }
          window.location = url;
        };
      }
      client.init(ignore_audio_blacklist);

      client.host = server;
      client.port = port;
      client.ssl = ssl;
      client.webtransport = webtransport;
      client.path = path.split("index.html")[0];
      return client;
    }

    function init_tablet_input(client) {
      //keyboard input for tablets:
      var pasteboard = $("#pasteboard");
      pasteboard.on("input", function (e) {
        var txt = pasteboard.val();
        pasteboard.val("");
        cdebug("keyboard", "oninput: '" + txt + "'");
        if (!client.topwindow) {
          return;
        }
        for (var i = 0; i < txt.length; i++) {
          var str = txt[i];
          var keycode = str.charCodeAt(0);
          var keyname = str;
          if (str in CHAR_TO_NAME) {
            keyname = CHAR_TO_NAME[str];
            if (keyname.includes("_")) {
              //ie: Thai_dochada
              var lang = keyname.split("_")[0];
              var key_language = KEYSYM_TO_LAYOUT[lang];
              client._check_browser_language(key_language);
            }
          }
          try {
            var modifiers = [];
            var keyval = keycode;
            var group = 0;
            var wid = client.topwindow;
            var packet = ["key-action", wid, keyname, true, modifiers, keyval, str, keycode, group];
            cdebug("keyboard", packet);
            client.send(packet);
            packet = ["key-action", wid, keyname, false, modifiers, keyval, str, keycode, group];
            cdebug("keyboard", packet);
            client.send(packet);
          } catch (e) {
            client.exc(e, "input handling error");
          }
        }
      });
    }

    function init_clipboard(client) {
      client.init_clipboard();
    }

    function init_keyboard(client) {
      var Keyboard = window.SimpleKeyboard.default;
      var kb = new Keyboard({
        onKeyPress: (button) => onKeyPress(button),
        onKeyReleased: (button) => onKeyReleased(button),
        display: {
          ".com": "|",
          "{tab}": "tab",
          "{lock}": "lock",
          "{shift}": "shift",
          "{bksp}": "bksp",
          "{space}": "space",
          "{enter}": "return",
        },
      });
      window.kb = kb;
      window.keyboardShifted = false;
      function onChange(input) {
        clog("Input changed", input);
      }
      function onKeyPress(button) {
        forward_key(true, button);
        if (button == "{shift}" || button == "{lock}") {
          if (window.keyboardShifted) {
            window.kb.setOptions({ layoutName: "default" });
          } else {
            window.kb.setOptions({ layoutName: "shift" });
          }
          window.keyboardShifted = !window.keyboardShifted;
        }
      }
      function onKeyReleased(button) {
        forward_key(false, button);
      }
      function forward_key(pressed, button) {
        var key =
          {
            "{bksp}": "Backspace",
            "{enter}": "Return",
            "{space}": "Space",
            "{tab}": "Tab",
            "{lock}": "CapsLock",
            "{shift}": "Shift",
            ".com": "|",
          }[button] || button;
        var e = {
          which: 0,
          keyCode: 0,
          key: key,
          code: key,
        };
        client._keyb_process(pressed, e);
      }
      var keyboard = getboolparam("keyboard", Utilities.isMobile());
      if (!keyboard) {
        $(".simple-keyboard").hide();
        $("#keyboard_button").css("color", "#777");
      } else {
        $(".simple-keyboard").show();
        $("#keyboard_button").css("color", "#111");
      }
    }
    function toggle_keyboard() {
      $(".simple-keyboard").toggle();
      if ($(".simple-keyboard").is(":visible")) {
        $("#keyboard_button").css("color", "#111");
      } else {
        $("#keyboard_button").css("color", "#777");
      }
    }

    function init_file_transfer(client) {
      if (!client.file_transfer) {
        $("upload_link").removeAttr("href");
        return;
      }

      function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        client.send_all_files(evt.dataTransfer.files);
      }
      function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = "copy";
      }
      var screen = document.getElementById("screen");
      screen.addEventListener("dragover", handleDragOver, false);
      screen.addEventListener("drop", handleFileSelect, false);

      $("#upload").on("change", function (evt) {
        evt.stopPropagation();
        evt.preventDefault();
        client.send_all_files(this.files);
        return false;
      });
      $("#upload_form").on("submit", function (evt) {
        evt.preventDefault();
      });
    }

    function init_clock(client, enabled) {
      $("#clock_menu_entry").hide();
      if (!enabled) {
        return;
      }
      function update_clock() {
        var now = new Date().getTime();
        var server_time =
          client.last_ping_server_time +
          (now - client.last_ping_local_time) +
          client.server_ping_latency;
        var date = new Date(server_time);
        var clock_text = $("#clock_text");
        var width = clock_text.width();
        clock_text.text(
          date.toLocaleDateString() + " " + date.toLocaleTimeString()
        );
        var clock_menu_text = $("#clock_menu_text");
        clock_menu_text.text(
          date.toLocaleDateString() + " " + date.toLocaleTimeString()
        );
        if (width != clock_text.width()) {
          //trays have been shifted left or right:
          client.reconfigure_all_trays();
        }
        //try to land at the half-second point,
        //so that we never miss displaying a second:
        var delay = (1500 - (server_time % 1000)) % 1000;
        if (delay < 10) {
          delay = 1000;
        }
        setTimeout(update_clock, delay);
      }

      function wait_for_time() {
        if (client.last_ping_local_time > 0) {
          $("#clock_menu_entry").show();
          update_clock();
        } else {
          //check again soon:
          //(ideally, we should register a callback on the ping packet)
          setTimeout(wait_for_time, 1000);
        }
      }
      wait_for_time();
    }

    function init_audio(client) {
      client.on_audio_state_change = function (newstate, details) {
        if (client.audio_state == newstate) {
          return;
        }
        client.audio_state = newstate;
        var tooltip;
        var data_icon;
        var sound_button_element = $("#sound_button");
        if (newstate == "disabled") {
          data_icon = "volume_up";
          tooltip = "audio is not available";
          sound_button_element.css("color", "#777");
        } else if (newstate == "playing") {
          data_icon = "volume_up";
          tooltip = "audio playing,\nclick to stop";
        } else if (newstate == "waiting") {
          data_icon = "volume_up";
          tooltip = "audio buffering";
        } else {
          data_icon = "volume_off";
          tooltip = "audio off,\nclick to start";
        }
        clog("audio-state:", newstate);
        sound_button_element.attr("data-icon", data_icon);
        sound_button_element.attr("title", tooltip);
      };
      $("#sound_button").click(function () {
        clog("speaker icon clicked, audio_enabled=", client.audio_enabled);
        if (!client.audio_enabled) {
          client.audio_state = "disabled";
        } else if (
          client.audio_state == "playing" ||
          client.audio_state == "waiting"
        ) {
          client.on_audio_state_change("stopped", "user action");
          client.close_audio();
        } else {
          client.on_audio_state_change("waiting", "user action");
          client._audio_start_stream();
          client._sound_start_receiving();
        }
      });
    }

    function toggle_fullscreen() {
      var f_el =
        Object.hasOwn(document, "requestFullScreen") ||
        Object.hasOwn(document, "webkitRequestFullScreen") ||
        Object.hasOwn(document, "mozRequestFullScreen") ||
        Object.hasOwn(document, "msRequestFullscreen");
      if (!f_el) {
        var elem = document.getElementById("fullscreen_button");
        var is_fullscreen = document.fullScreen || document.mozFullScreen || document.webkitIsFullScreen;
        if (!is_fullscreen) {
          var req =
            elem.requestFullScreen ||
            elem.webkitRequestFullScreen ||
            elem.mozRequestFullScreen ||
            elem.msRequestFullscreen;
          if (req) {
            req.call(document.body);

            // event codes: https://www.w3.org/TR/uievents-code/#key-alphanumeric-writing-system
            var keys = [
              "AltLeft",
              "AltRight",
              "Tab",
              "Escape",
              "ContextMenu",
              "MetaLeft",
              "MetaRight",
              "F1",
              "F2",
              "F3",
              "F4",
              "F5",
              "F6",
              "F7",
              "F8",
              "F9",
              "F10",
              "F11",
            ];
            navigator.keyboard
              .lock(keys)
              .then(() => {
                console.log("keyboard lock success");
              })
              .catch((e) => {
                console.log("keyboard lock failed: ", e);
              });

            $("#fullscreen").attr("src", "./icons/unfullscreen.png");
            elem.title = "Exit Fullscreen";
            $("#fullscreen_button").attr("data-icon", "fullscreen_exit");
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (Object.hasOwn((document, "mozCancelFullScreen"))) {
            document.mozCancelFullScreen();
          } else if (Object.hasOwn((document, "msExitFullscreen"))) {
            document.msExitFullscreen();
          }

          $("#fullscreen").attr("src", "./icons/fullscreen.png");
          elem.title = "Fullscreen";
          $("#fullscreen_button").attr("data-icon", "fullscreen");
        }
      }
    }

    function expand_float_menu() {
      var expanded_width = float_menu_item_size * float_menu_item_count;
      var float_menu = document.getElementById("float_menu");
      float_menu.style.display = "inline-block";
      float_menu.style.width = expanded_width + "px";
      $("#float_menu").children().show();
      if (client) {
        client.reconfigure_all_trays();
      }
    }

    function retract_float_menu() {
      document.getElementById("float_menu").style.width = "0px";
      $("#float_menu").children().hide();
    }

    function init_float_menu() {
      var toolbar_position = getparam("toolbar_position");
      var floating_menu = getboolparam("floating_menu", true);
      var autohide = getboolparam("autohide", false);
      var float_menu_element = $("#float_menu");
      if (!floating_menu) {
        //nothing to do, it starts hidden
        return;
      }
      float_menu_element.fadeIn();
      if (client) {
        client.toolbar_position = toolbar_position;
      }
      if (autohide) {
        float_menu_element.on("mouseover", expand_float_menu);
        float_menu_element.on("mouseout", retract_float_menu);
        // Expand and retract the floating menu so it
        // is correctly positioned and collapsed
        expand_float_menu();
        retract_float_menu();
      } else {
        expand_float_menu();
      }
    }

    function init_auth_autosubmit() {
      document.querySelector("#login_connect").addEventListener("keyup", password_special_keys);
      document.querySelector("#login_cancel").addEventListener("keyup", event => {
        if (event.keyCode == 27 || event.keyCode == 13) {
          event.preventDefault();
          login_cancel();
        }
      });
    }

    var client;
    function init_page() {
      clog("initializing page");
      var touchaction = getparam("touchaction") || "scroll";
      touchaction_scroll = touchaction == "scroll";
      set_touchaction();

      init_auth_autosubmit();

      client = init_client();
      addEventListener(
        "unload",
        () => {
          clog("onunload()");
          client.close();
        },
        { capture: true }
      );

      addEventListener(
        "beforeunload",
        () => {
          var aft = client.active_file_transfers();
          clog("beforeunload(", event, ") active_file_transfers()=", aft);
          if (aft > 0) {
            //This text is now ignored by all browsers...
            event.returnValue = "There are file transfers in progress.\nAre you sure you want to leave?";
          }
          return event.returnValue;
        },
        { capture: true }
      );
      client.on_connect = function () {
        init_float_menu();
        if (client.clipboard_enabled) {
          enable_clipboard_autofocus();
        }
        client.capture_keyboard = true;
      };
      var blocked_hosts = (getparam("blocked-hosts") || "").split(",");
      if (blocked_hosts.indexOf(client.host.toLowerCase()) >= 0) {
        var sane_host = client.host.replace(/[^A-Za-z0-9\.\:]/g, "");
        client.callback_close("connection to host '" + sane_host + "' blocked");
      } else {
        client.connect();
      }

      //from now on, send log and debug to client function
      //which may forward it to the server once connected:
      clog = function () {
        if (client) {
          client.log.apply(client, arguments);
        }
      };
      cdebug = function () {
        if (client) {
          client.debug.apply(client, arguments);
        }
      };
      clog("initializing subsystems");
      init_tablet_input(client);
      init_clipboard(client);
      init_file_transfer(client);
      init_keyboard(client);
      init_clock(client, getboolparam("clock", true));
      init_audio(client);
      document.addEventListener("visibilitychange", function (e) {
        var window_ids = Object.keys(client.id_to_window).map(Number);
        clog("visibilitychange hidden=", document.hidden, "connected=", client.connected);
        if (client.connected) {
          if (document.hidden) {
            client.suspend();
          } else {
            client.resume();
          }
        }
      });
      client.password_prompt_fn = password_prompt_fn;
      client.keycloak_prompt_fn = keycloak_prompt_fn;
      $("#fullscreen").on("click", function (e) {
        toggle_fullscreen();
      });

      $("#fullscreen_button").on("click", function (e) {
        toggle_fullscreen();
      });

      $("#keyboard_button").on("click", function (e) {
        toggle_keyboard();
      });

      $("#clipboard_button").on("click", function (e) {
        client.read_clipboard(e);
      });

      // Configure Xpra tray window list right click behavior.
      $("#open_windows_list")
        .siblings("a")
        .on("mousedown", (e) => {
          if (e.buttons === 2) {
            client.toggle_window_preview();
          }
        });

      var screen_change_events = "webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange";
      $(document).on(screen_change_events, function () {
        var f_el =
          document.fullscreenElement ||
          document.mozFullScreen ||
          document.webkitIsFullScreen ||
          document.msFullscreenElement;
        clog("fullscreenchange:", f_el);
        if (f_el == null) {
          //we're not in fullscreen mode now, so show fullscreen icon again:
          $("#fullscreen_button").attr("data-icon", "fullscreen");
        }
      });
      // disable right click menu:
      window.oncontextmenu = function (e) {
        var direction = client.clipboard_direction;
        if (client.clipboard_enabled && (direction === "to-client" || direction === "both")) {
          client._poll_clipboard(e);
        }
        e.preventDefault();
        e.stopPropagation();
        return false;
      };

      // Send clipboard from browser on focus if client-to-server clipboard is enabled.
      $(window).on("focus", (e) => {
        var direction = client.clipboard_direction;
        if (direction === "to-server" || direction === "both") {
          client._poll_clipboard(e);
        }
      });

      // Prevent stuck keys.
      $(window).on("blur", (e) => {
        if (
          client.last_key_packet.length > 2 &&
          client.last_keycode_pressed > 0
        ) {
          console.log("clearing keycode: " + client.last_keycode_pressed);
          key_packet = client.last_key_packet;
          // Set pressed = false to indicate key up.
          key_packet[3] = false;
          client.send(key_packet);
          client.last_key_packet = [];
        }
      });
    }

    function load_default_settings() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "./default-settings.txt");
      xhr.onload = function () {
        var tmp_default_settings = Utilities.parseINIString(
          xhr.responseText
        );
        clog("network", "got default settings:", tmp_default_settings);
        //update the default settings object
        //so getparam will look there
        for (var key in tmp_default_settings) {
          default_settings[key] = tmp_default_settings[key];
        }
        init_page();
      };
      xhr.onerror = function () {
        clog("network", "default settings request failed with code", xhr.status);
        init_page();
      };
      xhr.onabort = function () {
        clog("network", "default settings request aborted");
        init_page();
      };
      xhr.send();
    }

    $(document).ready(function () {
      clog("document is ready, browser is", navigator.platform, "64-bit:", Utilities.is_64bit());
      load_default_settings();
    });
    console.log("client.js loaded");

  </script>
</body>

</html>